name: P3P_Proxy_Scan

on:
  workflow_dispatch:

jobs:
  proxy_scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Residential Proxy Scan
        run: |
          # é…ç½®ç›®æ ‡
          TARGET="http://focus169.org:48719/68a6abe2000dd5d9a5012600500a1279"
          
          echo "ðŸŒ æ­£åœ¨å°è¯•é€šè¿‡æ¨¡æ‹Ÿé€šé“ç»•è¿‡æœºæˆ¿å°é”..."
          
          # æ ¸å¿ƒé€»è¾‘ï¼šåˆ©ç”¨å…è´¹/å…¬å…±ä»£ç†æ± ï¼ˆè¿™é‡Œä»¥æ¨¡æ‹Ÿé€»è¾‘ä¸ºä¾‹ï¼‰
          # åœ¨ GitHub çŽ¯å¢ƒä¸‹ï¼Œå¿…é¡»æŒ‚è½½ä¸€ä¸ª -x (proxy) æ‰èƒ½æ¨¡æ‹Ÿä½ è¯´çš„ç”µä¿¡å®½å¸¦
          # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„ä»£ç†åœ°å€ï¼Œå¦åˆ™ä¾ç„¶ä¼šå¤±è´¥
          
          # æˆ‘ä»¬å°è¯•ç”¨ curl çš„ä¼ªè£…å‚æ•°ï¼Œæ¨¡æ‹Ÿæœ€çœŸå®žçš„æµè§ˆå™¨è¡Œä¸º
          curl -I -s -m 10 \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "X-Forwarded-For: 114.247.50.110" \
            "$TARGET" > result.txt || echo "FAILED" > result.txt

          if grep -q "200 OK" result.txt; then
            echo "âœ… æ¨¡æ‹Ÿè¿žé€šæˆåŠŸï¼"
            echo "å‡¤å‡°ä¸­æ–‡,p3p://focus169.org:48719/68a6abe2000dd5d9a5012600500a1279" > active_port.txt
          else
            echo "âŒ æ¨¡æ‹Ÿå®¶ç”¨å®½å¸¦å¤±è´¥ã€‚åŽŸå› ï¼šGitHub çŽ¯å¢ƒæ— æ³•æ¨¡æ‹Ÿç‰©ç†å…‰çŒ«é‡å¯ã€‚"
            echo "âŒ å¤±è´¥ï¼šGitHub IP æ®µå·²è¢«æºæœåŠ¡å™¨æ°¸ä¹…æ‹‰é»‘ï¼Œå»ºè®®åˆ‡æ¢è‡³æœ¬åœ°è¿è¡Œã€‚" > active_port.txt
          fi

      - name: Push Result
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add active_port.txt
          git commit -m "Proxy test" || exit 0
          git push

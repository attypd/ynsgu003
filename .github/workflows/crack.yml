name: P3P_Turbo_Scan

on:
  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®å¼€å§‹æ‰«æ

jobs:
  turbo_scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: System Engine Scan
        run: |
          # 1. å®‰è£…ç³»ç»Ÿåº•å±‚æ‰«æå·¥å…· nc (Netcat)
          sudo apt-get update && sudo apt-get install -y netcat-openbsd

          # 2. é…ç½®æ‰«æç›®æ ‡
          TARGET_HOST="focus169.org"
          TARGET_PORT="48719"
          
          echo "ğŸ“¡ æ­£åœ¨å°è¯•ç‰©ç†æ’å‡»ç«¯å£ $TARGET_HOST:$TARGET_PORT ..."
          
          # 3. ä½¿ç”¨ nc è¿›è¡Œæé€Ÿç‰©ç†æ¢æµ‹ (ä¸è¿›å±‹è¯´è¯ï¼Œåªçœ‹å¤§é—¨å¼€æ²¡å¼€)
          # -z: ä»…æ‰«æ; -v: è¯¦ç»†; -w 1: 1ç§’è¶…æ—¶
          if nc -zv -w 1 $TARGET_HOST $TARGET_PORT 2>&1 | grep -q "succeeded"; then
            echo "âœ… ç«¯å£å¼€å¯ï¼æ­£åœ¨æŒ‰ P3P æ ¼å¼ç”Ÿæˆæœ€æ–°ç»“æœ..."
            # ä¸¥æ ¼æŒ‰ç…§ä½ è¦æ±‚çš„ p3p:// æ ¼å¼ç›´æ¥ç”Ÿæˆæ–‡ä»¶
            echo "å‡¤å‡°ä¸­æ–‡,p3p://$TARGET_HOST:$TARGET_PORT/68a6abe2000dd5d9a5012600500a1279" > active_port.txt
            echo "å‡¤å‡°èµ„è®¯,p3p://$TARGET_HOST:$TARGET_PORT/694531d0000414f210386f2756d64099" >> active_port.txt
            echo "å‡¤å‡°é¦™æ¸¯å°,p3p://$TARGET_HOST:$TARGET_PORT/68a6b0e900041c3da514c6d1105e4d0d" >> active_port.txt
            echo "ç¿¡ç¿ å°,p3p://$TARGET_HOST:$TARGET_PORT/694533620009fd15103e92fc6c853ea8" >> active_port.txt
          else
            echo "âŒ ç«¯å£ç‰©ç†å°é”ã€‚"
            # å†™å…¥å¸¦æ—¶é—´æˆ³çš„å¤±è´¥è®°å½•ï¼Œç¡®ä¿ä½ çŸ¥é“è„šæœ¬è·‘è¿‡äº†
            echo "âŒ æ‰«æå®Œæˆæ—¶é—´ $(date)ï¼Œæ£€æµ‹åˆ°ç‰©ç†å±‚å°é”ï¼ŒGitHub IP å¯èƒ½è¢«ç¦ã€‚" > active_port.txt
          fi

      - name: Commit and Push Result
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add active_port.txt
          # åªæœ‰æ–‡ä»¶æœ‰å˜åŠ¨æ—¶æ‰æäº¤ï¼Œé˜²æ­¢ä»»åŠ¡æŠ¥é”™
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update P3P results" && git push)
